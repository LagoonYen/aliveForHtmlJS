@page
@model AliveStoreTemplate.Pages.cartModel
@{
    ViewData["Title"] = "cart";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

@section HEAD{
    <style>
        .ico_cgpCount {
            background-repeat: no-repeat;
            background-position: left center;
            background-image: url(/img/ico_cgpCount.png);
            padding-left: 1em;
        }

        .ico_cgpTotal {
            background-repeat: no-repeat;
            background-position: left center;
            background-image: url(/img/ico_cgpBan.png);
            padding-left: 1em;
        }

        .td-price:before {
            content: "" !important;
        }
    </style>
}


@*cart 购物车*@
<article class="page cart">
    <div class="content-con">
        <h2 class="page-tit"><em>購物車</em><span>選購商品<em class="count spancc">3</em></span></h2>
        @*cart-recipient 收件资料*@
        <section class="forms-basic cart-recipient">
            <dl class="col2">
                <dt>收件人<em class="must">*</em></dt>
                <dd>
                    <input type="text" value="" placeholder="请填入收件人姓名" />
                </dd>
                <dt>收件人手机号<em class="must">*</em></dt>
                <dd>
                    <input type="tel" value="" placeholder="请填入收件人手机号" />
                </dd>
            </dl>
            <dl>
                <dt>收件人地址<em class="must">*</em></dt>
                <dd>
                    <div id="post" class="citys">
                        <select class="ui dropdown" style="min-width:80px" name="province" onchange="GetCityList()" id="province">
                            <option value="">請選擇</option>
                        </select>
                        <select class="ui dropdown" style="min-width:80px" name="city" onchange="GetCountryList()" id="city">
                            <option value="">請選擇</option>
                        </select>
                        <select class="ui dropdown" style="min-width:80px" name="area" onchange="GetTownList()" id="area">
                            <option value="">請選擇</option>
                        </select>
                        <select class="ui dropdown" style="min-width:80px" name="town" onchange="BulidAddr()" id="town">
                            <option value="">請選擇</option>
                        </select>
                        @*<input class="form-control" type="text" id="addr" />*@
                        <input class="" type="text" value="" placeholder="请填入地址" />
                    </div>
                </dd>
                <dt>备注</dt>
                <dd>
                    <textarea name="" cols="0" rows="3" style="resize:none;height:200px"></textarea>
                </dd>
            </dl>
        </section>
        @*cart-order 订单资料*@
        <section class="cart-order">
            <table class="forms-basic tab-basic tab-cart">
                <thead>
                    <tr>
                        <th class="td-check">
                            <a class="btn-check">
                                <input id="clickAll" type="checkbox" /><i class="icon-check"></i>
                            </a>
                        </th>
                        <th class="td-prod">商品</th>
                        <th>單價</th>
                        <th class="td-count">數量</th>
                        <th>小計</th>
                        <th class="td-action">&nbsp;</th>
                    </tr>
                </thead>
                <tbody id="tbOrder">
                    
                </tbody>
            </table>
        </section>
        @*cart-total 总计*@
        <section class="cart-total">
            <table class="forms-basic tab-total">
                <tr>
                    <th>
                        <span class="td-item">合计</span>
                    </th>
                    <td>
                        <span class="ico_cgpCount " id="lbProdTPrice">720</span>
                    </td>
                </tr>
                @*
                    <tr>
                        <th>
                            <span class="td-coupon">
                                <input type="text" value="" />
                                <button class="btn-active">新增</button>
                            </span>
                            <span class="td-item">优惠券</span>
                        </th>
                        <td class="td-price td-discount">100</td>
                    </tr>
                    <tr>
                        <th>
                            <span class="td-item">运费</span>
                        </th>
                        <td class="td-price">60</td>
                    </tr>*@
                <tr>
                    <th>
                        <span class="td-item">总计</span>
                    </th>
                    <td class="td-total td-price">
                        <span class="ico_cgpTotal td-total" id="lbTPrice">780</span>
                    </td>
                </tr>
            </table>
        </section>
        <section class="cart-action">
            <a href="checkout" class="btn-action">我要结算</a>
        </section>
    </div>
</article>


@section FOOTER{
    @*pgaeJs*@
    <script type="text/javascript">

        //商店名稱
        var merchantId = "alive"


        $(function () {
            // 全选
            $(".btn-check").click(function () {
                $(this).toggleClass('active');
            });

            //取得購物車
            GetProductFromCarBySession()

            //建立地址Select
            GetProvinceList()
        });

        //取得購物車
        function GetProductFromCarBySession(){
            $.ajax({
                type:"Get",
                url:"@Url.Action("GetProductFromCarBySession","Session")",
                processData : false, 
                contentType : 'application/json;charset=UTF-8',
                dataType:"json",
                async:false,  //可能不好
                success:function(response){
                    console.log("已連上GetProductFromCarBySession, 目前購物車清單", response)

                    BulidCarView(response);
                },
                error:function(response){
                    console.log("找不到")
                }
            })
        }

        //建立購物車畫面
        function BulidCarView(response){
            $("#tbOrder").empty()

            if(response != null){
                response.forEach(x =>{
                    //取得商品
                    let Product = GetProductById(x.productId)
                    //取得型號
                    let ProductSpec = GetProductSpecByProdSpecId(x.productSpecId)
                        
                    //取得所選型號
                    let SelectedSpec = ProductSpec.Name
                    let productSpecId = ProductSpec.Id
                    let SelectedSpecQuantity = ProductSpec.Quantity

                    console.log("二次Ajax", x, Product, ProductSpec, SelectedSpec, productSpecId)

                    let trTbody = $(`<tr></tr>`)
                    trTbody
                        .append(`<td class="td-check">
                                    <a class="btn-check">
                                        <input type="checkbox" value="1"/><i class="icon-check"></i>
                                    </a>
                                </td>`)
                        .append(`<td class="td-prod">
                                    <img src="https://n2imageservice.azurewebsites.net/api/images/shopmall/` + Product.MainImage + `/1550/0?1644815483672);" alt="" class="td-photo" />
                                    <p class="td-name">${Product["Title"]}</p>
                                    <p class="td-name" data-SpecId="${productSpecId}">${SelectedSpec}</p>
                                </td>`)
                        .append(`<td class="td-price" data-th="單價"><span>${Product["Price"]}</span></td>`)
                        .append(`<td class="td-count" data-th="">
                                    <div class="count-bar">
                                        <a class="btn-count" >
                                            <i class="minus circle icon" onclick="OrderNumChange()" data-symbol="minus" data-productid="${x.productId}" data-productSpecId="${productSpecId}" data-selectedspecquantity="${SelectedSpecQuantity}"></i>
                                        </a>
                                        <input class="CountInput" type="number" value="${x.amount}"/>
                                        <a class="btn-count">
                                            <i class="plus circle icon" onclick="OrderNumChange()" data-symbol="plus" data-productid="${x.productId}" data-productSpecId="${productSpecId}" data-selectedspecquantity="${SelectedSpecQuantity}"></i>
                                        </a>
                                    </div>
                                </td>`)
                        .append(`<td class="td-price" data-th="小計"><span>${x["subTotal"]}</span></td>`)
                        .append(`<td class="td-action">
                                    <a class="btn-delete">
                                        <i class="trash icon" onclick="DelProductfromCarBySession({productId:'${x["productId"]}', productSpecId:'${productSpecId}'})"></i>
                                    </a>
                                </td>`)
                    $("#tbOrder").append(trTbody)
                })
            }
        }

        //取得商品
        function GetProductById(productId){
            let data = false
            $.ajax({
                type:"Get",
                url:"https://localhost:44302/api/Product/GetProductById?merchantId=" + merchantId +"&productId=" + productId,
                processData : false, 
                contentType : 'application/json;charset=UTF-8',
                dataType:"json",
                async:false,  //可能不好
                success:function(response){
                    console.log("二次已連上GetProductById", response)
                    data = response
                },
                error:function(response){
                    console.log("找不到")
                }
            })
            return data
        } 

        //取得型號
        function GetProductSpecByProdSpecId(productSpecId){
            let data = false
            $.ajax({
                type:"GET",
                url:"https://localhost:44302/api/Product/GetProductSpecByProdSpecId?merchantId=" + merchantId +"&productSpecId=" + productSpecId,
                processData : false, 
                contentType : 'application/json;charset=UTF-8',
                dataType:"json",
                async:false, //可能不好
                success:function(response){
                    console.log("二次已連上GetProductSpecByProdSpecId", response)
                    data = response
                },
                error:function(response){
                    console.log("找不到")
                }
            })
            return data
        }

        //將購物車內商品移除
        function DelProductfromCarBySession(data){
            //let $this = $(event.target)
            //console.log("刪除", productId, productSpecId)
            console.log(data)
            let productId = data.productId
            let productSpecId = data.productSpecId
            //let productSpecId = data.selectedspecid

            $.ajax({
                type:"Post",
                url:"@Url.Action("DelProductfromCarBySession","Session")",
                data:JSON.stringify({
                    'ProductId' : productId,
                    'ProductSpecId' : productSpecId
                }),
                processData : false, 
                contentType : 'application/json;charset=UTF-8',
                //dataType:"json",  //不是json格式所以不用
                success:function(){
                    //console.log("已連上DelProductfromCarBySession", response)

                    //重構購物車
                    GetProductFromCarBySession()
                },
                error:function(response){
                    console.log("找不到")
                }
            })
        }

        //判定增減商品數量
        function OrderNumChange(){
            let $this = $(event.target)
            //符號, 商品id, 商品規格, 目前購物車內數量, 物品上限
            let symbol = $this.data("symbol")
            let productId = $this.data("productid")
            let productSpecId = $this.data("productspecid")
            let countNow = parseInt($this.parent().siblings(".CountInput").val()) //用不到
            let quantity = $this.data("selectedspecquantity")  //用不到
            console.log("符號, 商品id, 商品規格, 目前購物車內數量, 物品上限", symbol, productId, productSpecId, countNow, quantity)
            //判斷+-
            countNow = (symbol == "plus") ? countNow + 1 : countNow -1
            //判斷結果做事
            if(countNow > quantity){
                return
            }
            else if(countNow == 0){
                $this.parent().siblings(".CountInput").attr("value", countNow)
                    let data ={'productId' : productId, 'productSpecId' : productSpecId}
                    DelProductfromCarBySession(data)
            }
            else{
                $this.parent().siblings(".CountInput").attr("value", countNow)
                    UpdateCart(productId, productSpecId, symbol)
            }
            //if(symbol == "plus"){
            //    countNow = countNow + 1
            //    if(countNow > quantity){
            //        return
            //    }
            //    else{
            //        $this.parent().siblings(".CountInput").attr("value", countNow)
            //        UpdateCart(productId, productSpecId, symbol)
            //    }
            //}
            //else if(symbol == "minus"){
            //    countNow = countNow -1
            //    if(countNow == 0){
            //        $this.parent().siblings(".CountInput").attr("value", countNow)
            //        let data ={'productId' : productId, 'productSpecId' : productSpecId}
            //        DelProductfromCarBySession(data)
            //    }
            //    else{
            //        $this.parent().siblings(".CountInput").attr("value", countNow)
            //        UpdateCart(productId, productSpecId, symbol)
            //    }
            //}
        }

        //更新購物車單筆資料
        function UpdateCart(productId, productSpecId, symbol){
            $.ajax({
                type:"Post",
                url:"@Url.Action("PatchProductNumFromCarBySession","Session")",
                data:JSON.stringify({
                    'ProductId' : productId,
                    'ProductSpecId' : productSpecId,
                    'Symbol':symbol
                }),
                processData : false, 
                contentType : 'application/json;charset=UTF-8',
                success:function(response){
                    //重構購物車
                    BulidCarView(response)
                    //GetProductFromCarBySession()
                },
                error:function(response){
                    console.log("找不到")
                }
            })
        }

        //取得縣市
        function GetProvinceList(){
            $.ajax({
                type:"Get",
                url:"https://localhost:44302/api/Order/GetProvinceList",
                processData : false, 
                contentType : 'application/json;charset=UTF-8',
                dataType:"json",
                async:false,  //可能不好
                success:function(response){
                    console.log("二次已連上GetProvinceList", response)

                    response.forEach(x =>{
                        $("#province").append(`<option value="${x["id"]}" >${x["name"]}</option>`)
                    })
                },
                error:function(response){
                    console.log("找不到")
                }
            })
        }

        //取得城鎮鄉鎮
        function GetCityList(){
            let province = $("#province").val()
            $.ajax({
                type:"Get",
                url:"https://localhost:44302/api/Order/GetCityList?lastLevelId=" + province,
                processData : false, 
                contentType : 'application/json;charset=UTF-8',
                dataType:"json",
                async:false,  //可能不好
                success:function(response){
                    console.log("二次已連上GetCityList", response)
                    let option = (`<option value="">請選擇</option>`)
                    $("#city").empty();
                    $("#city").append(option)
                    $("#area").empty();
                    $("#area").append(option)
                    $("#town").empty()
                    $("#town").append(option)

                    response.forEach(x =>{
                        $("#city").append(`<option value="${x["id"]}" >${x["name"]}</option>`)
                    })
                },
                error:function(response){
                    console.log("找不到")
                }
            })
        }

        //取得地區
        function GetCountryList(){
            let city = $("#city").val()
            $.ajax({
                type:"Get",
                url:"https://localhost:44302/api/Order/GetCountyList?lastLevelId=" + city,
                processData : false, 
                contentType : 'application/json;charset=UTF-8',
                dataType:"json",
                async:false,  //可能不好
                success:function(response){
                    console.log("二次已連上GetCountyList", response)
                    let option = (`<option value="">請選擇</option>`)
                    $("#area").empty();
                    $("#area").append(option)
                    $("#town").empty()
                    $("#town").append(option)

                    response.forEach(x =>{
                        $("#area").append(`<option value="${x["id"]}" >${x["name"]}</option>`)
                    })
                },
                error:function(response){
                    console.log("找不到")
                }
            })
        }
        
        //取得路名
        function GetTownList(){
            let area = $("#area").val()
            $.ajax({
                type:"Get",
                url:"https://localhost:44302/api/Order/GetTownList?lastLevelId=" + area,
                processData : false, 
                contentType : 'application/json;charset=UTF-8',
                dataType:"json",
                async:false,  //可能不好
                success:function(response){
                    console.log("二次已連上GetTownList", response)
                    let option = (`<option value="">請選擇</option>`)
                    $("#town").empty()
                    $("#town").append(option)

                    response.forEach(x =>{
                        $("#town").append(`<option value="${x["id"]}" >${x["name"]}</option>`)
                    })
                },
                error:function(response){
                    console.log("找不到")
                }
            })
        }

        //地址完成後改變input
        function BulidAddr(){
            console.log("地址建立完成", $("#province option:selected").text(), $("#city option:selected").text(), $("#area option:selected").text(), $("#town option:selected").text())
        }

        //建立訂單
        function PlaceOrder(){
            $.ajax({
                type:"Post",
                url:"https://localhost:44302/api/Order/GetTownList?lastLevelId=" + area,
                processData : false, 
                contentType : 'application/json;charset=UTF-8',
                dataType:"json",
                async:false,  //可能不好
                success:function(response){
                    console.log("二次已連上GetTownList", response)
                    let option = (`<option value="">請選擇</option>`)
                    $("#town").empty()
                    $("#town").append(option)

                    response.forEach(x =>{
                        $("#town").append(`<option value="${x["id"]}" >${x["name"]}</option>`)
                    })
                },
                error:function(response){
                    console.log("找不到")
                }
            })
        }

        //Test訂單資料
        //{
        //  "MerchantId": "alive",
        //  "BuyerName": "Hsu",
        //  "BuyerMobile": "0972753301",
        //  "BuyerAddress": "光明街",
        //  "BuyerRemark": "NO",
        //  "BuyerAddressProvinceCode": "110000000000",
        //  "BuyerAddressCityCode": "110100000000",
        //  "BuyerAddressCountyCode": "110101000000",
        //  "BuyerAddressTownCode": "110101001000",
        //  "BuyerAddressProvince": "北京市",
        //  "BuyerAddressCity": "市辖区",
        //  "BuyerAddressCounty": "东城区",
        //  "BuyerAddressTown": "东华门街道办事处",
        //  "Items": [
        //    {
        //      "ProductId": "a3279dae3b0542b6a353e87d921da95b",
        //      "ProductSpecId": "7273d54adaa44bc88bd7fc3c7518c752",
        //      "ProductName": "Bose｜SoundSport运动无线蓝牙耳机",
        //      "Price": 1409,
        //      "ProductSpecName": "蓝色",
        //      "storageQuantity": 1,
        //      "BuyQuantity": "1",
        //      "TotalPrice": 1409
        //    }
        //  ],
        //  "PaymentType": "CGP"
        //}
    </script>
}